Thanks to [https://github.com/munshigroup/kthread](https://github.com/munshigroup/kthread) for this code! Needed to be modified slightly, so I just included it here.